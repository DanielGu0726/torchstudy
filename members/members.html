<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Members – TORCH</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    /* Card: horizontal – photo left, info right */
    .member-row-card { display: grid; grid-template-columns: 264px 1fr; gap: 32px; align-items: start; background: var(--white); border-radius: var(--radius-lg); padding: 28px; box-shadow: var(--shadow); border: 1.5px solid var(--border); margin-bottom: 16px; transition: border-color .2s, box-shadow .2s; }
    .member-row-card.has-artwork { cursor: pointer; }
    .member-row-card.has-artwork:hover { border-color: var(--primary); box-shadow: 0 6px 28px rgba(0,0,0,.12); }
    .member-row-card:not(.has-artwork):hover { border-color: var(--primary); }

    /* Avatar: 264px (3× original 88px) */
    .member-avatar-lg { width: 264px; height: 264px; border-radius: 50%; overflow: hidden; background: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 5rem; font-weight: 700; color: #fff; flex-shrink: 0; }
    .member-avatar-lg img { width: 100%; height: 100%; object-fit: cover; }

    /* Info block */
    .member-card-info { min-width: 0; }
    .member-info-name { font-size: 1.15rem; font-weight: 700; margin-bottom: 4px; }
    .member-info-title { font-size: .85rem; color: var(--primary); font-weight: 600; margin-bottom: 6px; }
    .member-info-workplace { font-size: .88rem; color: var(--text-muted); margin-bottom: 10px; }

    /* Bio: preserve newlines & spaces exactly as entered */
    .member-info-bio { font-size: .88rem; color: var(--text-muted); line-height: 1.75; white-space: pre-line; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }

    /* Artwork hint badge (shows on cards that have artwork) */
    .artwork-hint { display: inline-flex; align-items: center; gap: 5px; margin-top: 14px; font-size: .78rem; color: var(--primary); font-weight: 600; opacity: .75; }

    /* Sort bar */
    .sort-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 24px; flex-wrap: wrap; }
    .sort-bar label { font-size: .85rem; color: var(--text-muted); font-weight: 500; }
    .sort-bar select { padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: .85rem; background: var(--white); color: var(--text); }

    /* Mobile: stack vertically */
    @media(max-width:640px) {
      .member-row-card { grid-template-columns: 1fr; justify-items: center; }
      .member-avatar-lg { width: 180px; height: 180px; font-size: 3.5rem; }
      .member-card-info { width: 100%; }
    }

    /* ── Lightbox ──────────────────────────── */
    #artwork-lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.93); z-index: 9999; align-items: center; justify-content: center; }
    #artwork-lightbox.open { display: flex; }
    #artwork-lightbox img { max-width: 90vw; max-height: 88vh; object-fit: contain; border-radius: 6px; box-shadow: 0 8px 48px rgba(0,0,0,.6); pointer-events: none; display: block; }
    #lightbox-close { position: absolute; top: 20px; right: 28px; color: #fff; font-size: 2.4rem; line-height: 1; cursor: pointer; background: none; border: none; padding: 0; opacity: .8; transition: opacity .15s; }
    #lightbox-close:hover { opacity: 1; }
    .lightbox-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,.15); color: #fff; border: none; border-radius: 50%; width: 48px; height: 48px; font-size: 1.6rem; cursor: pointer; transition: background .15s; display: none; align-items: center; justify-content: center; }
    .lightbox-nav:hover { background: rgba(255,255,255,.3); }
    #lightbox-prev { left: 20px; }
    #lightbox-next { right: 20px; }
    #lightbox-counter { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,.8); font-size: .88rem; font-weight: 600; display: none; background: rgba(0,0,0,.4); padding: 4px 12px; border-radius: 20px; }
  </style>
</head>
<body>
<nav class="navbar">
  <div class="nav-inner">
    <a href="../index.html" class="nav-logo"><div class="logo-icon">🔥</div>TORCH</a>
    <div class="nav-links">
      <div class="nav-item"><a href="../index.html" class="nav-link">Home</a></div>
      <div class="nav-item"><a href="../about.html" class="nav-link">About</a></div>
      <div class="nav-item"><a href="../activity/index.html" class="nav-link">Activity</a></div>
      <div class="nav-item"><span class="nav-link">Registration <svg viewBox="0 0 10 6" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 1l4 4 4-4"/></svg></span><div class="dropdown"><a href="../registration/study.html">Study Group</a><a href="../registration/symposium.html">Symposium</a><a href="../registration/workshop.html">Workshop</a></div></div>
      <div class="nav-item"><a href="../sponsor.html" class="nav-link">Sponsor</a></div>
      <div class="nav-item"><a href="members.html" class="nav-link active">Members</a></div>
      <div class="nav-item"><a href="../news/index.html" class="nav-link">News</a></div>
      <div class="nav-item"><a href="../contact.html" class="nav-link">Contact</a></div>
    </div>
    <div class="hamburger"><span></span><span></span><span></span></div>
  </div>
</nav>
<div class="mobile-menu">
  <a href="../index.html" class="mobile-link">Home</a>
  <a href="../about.html" class="mobile-link">About</a>
  <a href="members.html" class="mobile-link">Members 소개</a>
  <a href="../contact.html" class="mobile-link">Contact</a>
</div>

<div class="page-header">
  <div class="container">
    <span class="eyebrow">Community</span>
    <h1>TORCH Members</h1>
    <p>TORCH를 함께 만들어가는 사람들을 소개합니다.</p>
    <div class="breadcrumb"><a href="../index.html">Home</a><span>/</span><span>Members</span></div>
  </div>
</div>

<section class="section section-light">
  <div class="container">

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="president">🔥 회장 인사말</button>
      <button class="tab-btn" data-tab="alumni">📚 역대 Members</button>
      <button class="tab-btn" data-tab="current">👥 2026 TORCH Members</button>
    </div>

    <!-- ── Tab 1: 회장 인사말 ──────────────────────── -->
    <div id="tab-president" class="tab-pane active">
      <div class="president-section">
        <div style="text-align:center">
          <div class="president-photo" id="president-photo">🔥</div>
          <div style="margin-top:18px">
            <div style="font-size:1.05rem;font-weight:700" id="president-name">—</div>
            <div style="font-size:.85rem;color:var(--text-muted);margin-top:2px" id="president-title-display">—</div>
          </div>
        </div>
        <div>
          <div class="quote-mark">"</div>
          <p class="greeting-text" id="president-bio-display" style="white-space:pre-line">
            불러오는 중…
          </p>
          <div style="margin-top:28px;padding-top:20px;border-top:1px solid var(--border);font-size:.9rem;color:var(--text-muted)">
            <span id="president-title-sign">—</span> <strong style="color:var(--text)" id="president-sign">—</strong>
          </div>
        </div>
      </div>
    </div>

    <!-- ── Tab 2: 역대 Members ──────────────────────── -->
    <div id="tab-alumni" class="tab-pane">
      <!-- Sort bar -->
      <div class="sort-bar">
        <label>정렬:</label>
        <select id="alumni-sort" onchange="renderAlumni()">
          <option value="year-desc">연도 (최신순)</option>
          <option value="year-asc">연도 (오래된순)</option>
          <option value="name-asc">이름 (가나다순)</option>
          <option value="workplace-asc">소속 (가나다순)</option>
        </select>
      </div>
      <div id="alumni-list">
        <div style="text-align:center;padding:60px;color:var(--text-muted)">불러오는 중…</div>
      </div>
    </div>

    <!-- ── Tab 3: 2026 TORCH Members ─────────────────── -->
    <div id="tab-current" class="tab-pane">
      <div class="sort-bar">
        <label>정렬:</label>
        <select id="current-sort" onchange="renderCurrent()">
          <option value="order-asc">기본 순서</option>
          <option value="name-asc">이름 (가나다순)</option>
          <option value="workplace-asc">소속 (가나다순)</option>
        </select>
      </div>
      <div id="current-list">
        <div style="text-align:center;padding:60px;color:var(--text-muted)">불러오는 중…</div>
      </div>
    </div>

  </div>
</section>

<!-- ── Artwork Lightbox ─────────────────────── -->
<div id="artwork-lightbox" onclick="closeLightbox()">
  <button id="lightbox-close" onclick="closeLightbox()" aria-label="닫기">✕</button>
  <button id="lightbox-prev" class="lightbox-nav" onclick="event.stopPropagation();lightboxNav(-1)" aria-label="이전">‹</button>
  <img id="lightbox-img" src="" alt="Artwork">
  <button id="lightbox-next" class="lightbox-nav" onclick="event.stopPropagation();lightboxNav(1)" aria-label="다음">›</button>
  <div id="lightbox-counter"></div>
</div>

<footer class="footer">
  <div class="container">
    <div class="footer-grid">
      <div class="footer-brand">
        <a href="../index.html" class="nav-logo"><div class="logo-icon">🔥</div>TORCH</a>
        <p style="margin-top:12px">Korea Young Dental Technician Study<br>기술 · 기회 · 보완 · 도전 · 희망</p>
        <div style="margin-top:16px"><a href="https://www.instagram.com/t_o_r_c_h_study/" target="_blank" class="btn btn-sm" style="background:rgba(255,255,255,.08);color:rgba(255,255,255,.7);border:1px solid rgba(255,255,255,.15)">📷 @t_o_r_c_h_study</a></div>
      </div>
      <div class="footer-col"><h4>Pages</h4><ul><li><a href="../about.html">About</a></li><li><a href="../activity/index.html">Activity</a></li><li><a href="../sponsor.html">Sponsor</a></li></ul></div>
      <div class="footer-col"><h4>Registration</h4><ul><li><a href="../registration/study.html">Study Group</a></li><li><a href="../registration/symposium.html">Symposium</a></li><li><a href="../registration/workshop.html">Workshop</a></li></ul></div>
      <div class="footer-col"><h4>Community</h4><ul><li><a href="../news/index.html">News</a></li><li><a href="members.html">Members</a></li><li><a href="../contact.html">Contact</a></li></ul></div>
    </div>
    <div class="footer-bottom">
      <span>© 2025 TORCH – Korea Young Dental Technician Study. All rights reserved.</span>
      <div class="social-links">
        <a href="https://www.instagram.com/t_o_r_c_h_study/" target="_blank" class="social-link" title="Instagram">📷</a>
      </div>
    </div>
  </div>
</footer>

<script src="../js/theme.js"></script>
<script>
/* ── Tab switching ─────────────────────────── */
let alumniLoaded = false, currentLoaded = false;

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    this.classList.add('active');
    document.getElementById('tab-' + this.dataset.tab).classList.add('active');

    if (this.dataset.tab === 'alumni' && !alumniLoaded) {
      loadAllMembers();
      alumniLoaded = true;
    }
    if (this.dataset.tab === 'current' && !currentLoaded) {
      loadCurrentMembers();
      currentLoaded = true;
    }
  });
});

/* ── Escape HTML ────────────────────────────── */
function esc(str) {
  return (str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ── President ──────────────────────────────── */
async function loadPresident() {
  try {
    const res = await fetch('/api/president');
    if (!res.ok) throw new Error();
    const p = await res.json();

    // Photo
    const photoEl = document.getElementById('president-photo');
    if (p.photo) {
      photoEl.innerHTML = `<img src="${esc(p.photo)}" alt="${esc(p.name)}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
    }

    // Name & title
    document.getElementById('president-name').textContent = p.name || '—';
    document.getElementById('president-title-display').textContent = p.title || '—';
    document.getElementById('president-sign').textContent = p.name || '—';
    document.getElementById('president-title-sign').textContent = p.title || '—';

    // Bio (greeting)
    const bioEl = document.getElementById('president-bio-display');
    if (p.bio) {
      bioEl.textContent = p.bio;
    } else {
      bioEl.innerHTML = `안녕하세요, TORCH 회원 여러분.<br><br>
저는 TORCH가 단순한 스터디 그룹이 아니라, 대한민국 치과기공 업계의 미래를 함께 만들어가는 공동체라고 믿습니다.<br><br>
TORCH는 <strong>T</strong>echnology(기술), <strong>O</strong>pportunity(기회), <strong>R</strong>edeem(보완), <strong>C</strong>hallenge(도전), <strong>H</strong>ope(희망) — 이 다섯 가지 가치를 중심으로 모인 젊은 치과기공사들의 모임입니다.<br><br>
여러분의 참여와 열정이 TORCH를 더욱 빛나게 합니다. 함께해 주셔서 감사합니다.`;
    }
  } catch {
    // keep default fallback text
  }
}

/* ── All members (역대 – includes 2026 current) ── */
let allMembersData = [];

async function loadAllMembers() {
  const container = document.getElementById('alumni-list');
  try {
    const res = await fetch('/api/members-list');  // no category filter → all members
    if (!res.ok) throw new Error();
    const { members } = await res.json();
    allMembersData = members || [];
    renderAlumni();
  } catch {
    container.innerHTML = `<div style="text-align:center;padding:60px;color:var(--text-muted)">
      <div style="font-size:3rem;margin-bottom:16px">📚</div>
      <p>역대 회원 정보를 불러올 수 없습니다.</p>
    </div>`;
  }
}

function renderAlumni() {
  const container = document.getElementById('alumni-list');
  if (!allMembersData.length) {
    container.innerHTML = `<div style="text-align:center;padding:60px;color:var(--text-muted)">
      <div style="font-size:3rem;margin-bottom:16px">📚</div><p>등록된 회원이 없습니다.</p></div>`;
    return;
  }

  const sortKey = document.getElementById('alumni-sort').value;
  let sorted = [...allMembersData];

  if (sortKey === 'year-desc') {
    sorted.sort((a, b) => (b.year || 0) - (a.year || 0) || (a.order_num || 0) - (b.order_num || 0));
  } else if (sortKey === 'year-asc') {
    sorted.sort((a, b) => (a.year || 0) - (b.year || 0) || (a.order_num || 0) - (b.order_num || 0));
  } else if (sortKey === 'name-asc') {
    sorted.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ko'));
  } else if (sortKey === 'workplace-asc') {
    sorted.sort((a, b) => (a.workplace || '').localeCompare(b.workplace || '', 'ko'));
  }

  // Group by year
  const byYear = {};
  sorted.forEach(m => {
    const y = m.year || '기타';
    if (!byYear[y]) byYear[y] = [];
    byYear[y].push(m);
  });

  // Year order depends on sort
  let years = Object.keys(byYear);
  if (sortKey === 'year-asc') {
    years.sort((a, b) => Number(a) - Number(b));
  } else if (sortKey === 'year-desc') {
    years.sort((a, b) => Number(b) - Number(a));
  }
  // For name/workplace sort, keep insertion order (already sorted above)

  container.innerHTML = years.map(y => `
    <div class="year-group">
      <div class="year-label">${esc(y)} Members</div>
      ${byYear[y].map(m => buildMemberCard(m)).join('')}
    </div>
  `).join('');
}

/* ── 2026 current members ─────────────────── */
let currentMembersData = [];

async function loadCurrentMembers() {
  const container = document.getElementById('current-list');
  try {
    const res = await fetch('/api/members-list?category=current');
    if (!res.ok) throw new Error();
    const { members } = await res.json();

    if (!members || !members.length) {
      container.innerHTML = `<div style="text-align:center;padding:60px;color:var(--text-muted)">
        <div style="font-size:3rem;margin-bottom:16px">👥</div>
        <p>2026 회원 소개를 준비 중입니다.</p>
        <p style="font-size:.88rem">문의: <a href="../contact.html">contact 페이지</a> 또는 <a href="https://www.instagram.com/t_o_r_c_h_study/" target="_blank">Instagram</a></p>
      </div>`;
      return;
    }
    currentMembersData = members;
    renderCurrent();
  } catch(e) {
    container.innerHTML = `<div style="text-align:center;padding:60px;color:var(--text-muted)">데이터를 불러올 수 없습니다.</div>`;
  }
}

function renderCurrent() {
  const container = document.getElementById('current-list');
  if (!currentMembersData.length) return;

  const sortKey = document.getElementById('current-sort').value;
  let sorted = [...currentMembersData];

  if (sortKey === 'name-asc') {
    sorted.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ko'));
  } else if (sortKey === 'workplace-asc') {
    sorted.sort((a, b) => (a.workplace || '').localeCompare(b.workplace || '', 'ko'));
  } else {
    sorted.sort((a, b) => (a.order_num || 0) - (b.order_num || 0));
  }

  container.innerHTML = sorted.map(m => buildMemberCard(m)).join('');
}

/* ── Build member card ──────────────────────── */
const _artworkStore = {};
let _cardIdx = 0;

function parseArtworks(raw) {
  if (!raw) return [];
  try {
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [raw];
  } catch { return [raw]; }
}

function buildMemberCard(m) {
  const initial = (m.name || '?').replace(/\s/g, '')[0] || '?';
  const avatar = m.photo
    ? `<img src="${esc(m.photo)}" alt="${esc(m.name)}">`
    : initial;

  const webpage = m.webpage
    ? `<div style="margin-top:14px"><a href="${esc(m.webpage)}" target="_blank" rel="noopener" class="btn btn-sm btn-dark" style="font-size:.78rem;padding:5px 12px" onclick="event.stopPropagation()">🌐 웹사이트</a></div>`
    : '';

  const artworks = parseArtworks(m.artwork);
  let cardAttrs = 'class="member-row-card"';
  let artworkHint = '';
  if (artworks.length > 0) {
    const idx = _cardIdx++;
    _artworkStore[idx] = m.artwork; // raw string (single b64 or JSON array)
    cardAttrs = `class="member-row-card has-artwork" onclick="openLightbox(_artworkStore[${idx}])"`;
    artworkHint = `<div class="artwork-hint">🖼 Artwork${artworks.length > 1 ? ' ' + artworks.length + '장' : ''} 보기</div>`;
  }

  return `
    <div ${cardAttrs}>
      <div class="member-avatar-lg">${avatar}</div>
      <div class="member-card-info">
        <div class="member-info-name">${esc(m.name)}</div>
        ${m.title    ? `<div class="member-info-title">${esc(m.title)}</div>` : ''}
        ${m.workplace? `<div class="member-info-workplace">📍 ${esc(m.workplace)}</div>` : ''}
        ${m.bio      ? `<div class="member-info-bio">${esc(m.bio)}</div>` : ''}
        ${artworkHint}
        ${webpage}
      </div>
    </div>`;
}

/* ── Lightbox (carousel) ────────────────────── */
let _lightboxImages = [];
let _lightboxIdx = 0;

function openLightbox(artworkRaw) {
  _lightboxImages = parseArtworks(artworkRaw);
  _lightboxIdx = 0;
  _renderLightbox();
  document.getElementById('artwork-lightbox').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function _renderLightbox() {
  document.getElementById('lightbox-img').src = _lightboxImages[_lightboxIdx] || '';
  const multi = _lightboxImages.length > 1;
  const prev = document.getElementById('lightbox-prev');
  const next = document.getElementById('lightbox-next');
  const counter = document.getElementById('lightbox-counter');
  prev.style.display = multi && _lightboxIdx > 0 ? 'flex' : 'none';
  next.style.display = multi && _lightboxIdx < _lightboxImages.length - 1 ? 'flex' : 'none';
  if (multi) {
    counter.textContent = `${_lightboxIdx + 1} / ${_lightboxImages.length}`;
    counter.style.display = 'block';
  } else {
    counter.style.display = 'none';
  }
}

function lightboxNav(dir) {
  _lightboxIdx = Math.max(0, Math.min(_lightboxImages.length - 1, _lightboxIdx + dir));
  _renderLightbox();
}

function closeLightbox() {
  document.getElementById('artwork-lightbox').classList.remove('open');
  document.getElementById('lightbox-img').src = '';
  _lightboxImages = [];
  document.body.style.overflow = '';
}

document.addEventListener('keydown', e => {
  if (!document.getElementById('artwork-lightbox').classList.contains('open')) return;
  if (e.key === 'Escape') closeLightbox();
  if (e.key === 'ArrowLeft')  lightboxNav(-1);
  if (e.key === 'ArrowRight') lightboxNav(1);
});

/* ── Init ───────────────────────────────────── */
loadPresident();
</script>
</body>
</html>
