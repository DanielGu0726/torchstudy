<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ â€“ TORCH</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .admin-layout { display: grid; grid-template-columns: 220px 1fr; gap: 24px; align-items: start; }
    @media (max-width: 768px) { .admin-layout { grid-template-columns: 1fr; } }
    .toggle-pill { position: relative; width: 52px; height: 28px; cursor: pointer; display:inline-flex; }
    .toggle-pill input { opacity: 0; width: 0; height: 0; position:absolute; }
    .toggle-track { position: absolute; inset: 0; border-radius: 14px; background: #ccc; transition: background .25s; }
    .toggle-knob  { position: absolute; top: 4px; left: 4px; width: 20px; height: 20px; background: #fff; border-radius: 50%; box-shadow: 0 1px 4px rgba(0,0,0,.25); transition: transform .25s; }
    .toggle-pill input:checked ~ .toggle-track { background: var(--primary); }
    .toggle-pill input:checked ~ .toggle-knob  { transform: translateX(24px); }
    .reg-status-toggle { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--light); border-radius: var(--radius); border: 1.5px solid var(--border); }
    .status-badge { font-size: .88rem; font-weight: 600; }
    .table-actions { display: flex; gap: 6px; flex-wrap:wrap; }
    .table-actions button { padding: 4px 8px; font-size: .78rem; border-radius: 4px; border: 1px solid var(--border); background: var(--white); cursor: pointer; color:var(--text); }
    .table-actions button:hover { background: var(--light); }
    .filter-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    .filter-row select { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: .85rem; background: var(--white); color: var(--text); }
    .setting-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); gap:12px; }
    .setting-row:last-child { border-bottom: none; }
    .setting-row input, .setting-row select { max-width: 280px; }
    #toast { position: fixed; bottom: 24px; right: 24px; background: #1a1a2e; color: #fff; padding: 12px 20px; border-radius: 8px; font-size: .88rem; opacity: 0; transform: translateY(8px); transition: all .25s; pointer-events: none; z-index: 9999; }
    #toast.show { opacity: 1; transform: translateY(0); }
    .admin-panel { display:none; }
    .admin-panel.active { display:block; }
    .sidebar-link { cursor:pointer; }
    .img-preview { max-width:100%;max-height:120px;object-fit:contain;border-radius:var(--radius);margin-top:8px;border:1px solid var(--border); }
    .form-inline { display:grid;grid-template-columns:1fr 1fr;gap:12px; }
    @media(max-width:600px){ .form-inline{grid-template-columns:1fr;} }
    .message-card { background:var(--white);border-radius:var(--radius);padding:18px;border:1.5px solid var(--border);margin-bottom:12px; }
    .message-card.unread { border-left:4px solid var(--primary); }
    .message-meta { font-size:.8rem;color:var(--text-muted);margin-bottom:8px;display:flex;gap:12px;flex-wrap:wrap; }
    .message-body { font-size:.88rem;line-height:1.6;white-space:pre-wrap; }
    .modal-overlay { position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:8000;display:flex;align-items:center;justify-content:center;padding:20px; }
    .modal-box { background:var(--white);border-radius:var(--radius-lg);padding:28px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto; }
    .modal-box h3 { margin-bottom:16px; }
  </style>
</head>
<body>

<nav class="navbar">
  <div class="nav-inner">
    <a href="../index.html" class="nav-logo"><div class="logo-icon">ğŸ”¥</div>TORCH</a>
    <div class="nav-links">
      <div class="nav-item"><a href="../index.html" class="nav-link">ì‚¬ì´íŠ¸</a></div>
      <div class="nav-item"><a href="/admin/" class="nav-link active">Admin</a></div>
    </div>
    <div class="nav-cta">
      <button class="btn btn-outline btn-sm" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <div class="hamburger"><span></span><span></span><span></span></div>
  </div>
</nav>

<div class="page-header">
  <div class="container">
    <span class="eyebrow">Administration</span>
    <h1>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <p>ì‹ ì²­ í˜„í™©, ì½˜í…ì¸ , ì‚¬ì´íŠ¸ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
  </div>
</div>

<section class="section section-light">
  <div class="container">

    <!-- KPI -->
    <div class="kpi-grid" style="margin-bottom:28px" id="kpi-grid">
      <div class="kpi-card"><div class="kpi-label">ì´ ì‹ ì²­</div><div class="kpi-value" id="kpi-total">â€”</div></div>
      <div class="kpi-card"><div class="kpi-label">ìŠ¤í„°ë””</div><div class="kpi-value" id="kpi-study">â€”</div></div>
      <div class="kpi-card"><div class="kpi-label">ì›Œí¬ìƒµ</div><div class="kpi-value" id="kpi-workshop">â€”</div></div>
      <div class="kpi-card"><div class="kpi-label">ë¯¸ì½ì€ ë©”ì‹œì§€</div><div class="kpi-value" id="kpi-messages">â€”</div></div>
    </div>

    <div class="admin-layout">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-title">ì½˜í…ì¸ </div>
        <div class="sidebar-link active" data-panel="panel-registrations">ğŸ“‹ ì‹ ì²­ ê´€ë¦¬</div>
        <div class="sidebar-link" data-panel="panel-workshop">ğŸ› ï¸ Workshop ì„¤ì •</div>
        <div class="sidebar-link" data-panel="panel-activity">ğŸ¯ Activity ê´€ë¦¬</div>
        <div class="sidebar-link" data-panel="panel-members">ğŸ‘¥ Members ê´€ë¦¬</div>
        <div class="sidebar-link" data-panel="panel-news">ğŸ“° News ê´€ë¦¬</div>
        <div class="sidebar-link" data-panel="panel-sponsors">ğŸ¤ Sponsor ê´€ë¦¬</div>
        <div class="sidebar-link" data-panel="panel-messages">ğŸ’¬ ë©”ì‹œì§€í•¨</div>
        <div class="sidebar-title" style="margin-top:12px">ì„¤ì •</div>
        <div class="sidebar-link" data-panel="panel-settings">âš™ï¸ ì‚¬ì´íŠ¸ ì„¤ì •</div>
      </div>

      <!-- Main -->
      <div class="main-panel">

        <!-- â”€â”€ Panel: Registrations â”€â”€ -->
        <div id="panel-registrations" class="admin-panel active">
          <div class="panel">
            <div class="panel-header">
              <h3>ì‹ ì²­ ëª©ë¡</h3>
              <button class="btn btn-primary btn-sm" onclick="exportCSV()">ğŸ“¥ CSV</button>
            </div>
            <div class="filter-row">
              <select id="filter-type" onchange="loadRegistrations()">
                <option value="all">ì „ì²´ ìœ í˜•</option>
                <option value="study">ìŠ¤í„°ë””</option>
                <option value="symposium">ì‹¬í¬ì§€ì—„</option>
                <option value="workshop">ì›Œí¬ìƒµ</option>
              </select>
              <select id="filter-status" onchange="loadRegistrations()">
                <option value="all">ì „ì²´ ìƒíƒœ</option>
                <option value="pending">ê²€í†  ì¤‘</option>
                <option value="approved">ìŠ¹ì¸ë¨</option>
                <option value="rejected">ê±°ì ˆë¨</option>
              </select>
              <input class="form-control" id="reg-search" placeholder="ì´ë¦„ ê²€ìƒ‰â€¦"
                     style="max-width:200px;font-size:.85rem;padding:7px 12px"
                     oninput="filterTable()">
            </div>
            <div class="table-wrap">
              <table id="reg-table">
                <thead><tr><th>#</th><th>ìœ í˜•</th><th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>ì†Œì†</th><th>ë‚ ì§œ</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="reg-tbody"><tr><td colspan="8" style="text-align:center;padding:32px;color:var(--text-muted)">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- â”€â”€ Panel: Workshop â”€â”€ -->
        <div id="panel-workshop" class="admin-panel">
          <div class="panel">
            <div class="panel-header"><h3>Workshop ì„¤ì •</h3><button class="btn btn-primary btn-sm" onclick="saveWorkshop()">ì €ì¥</button></div>

            <div class="reg-status-toggle" style="margin-bottom:20px">
              <label class="toggle-pill">
                <input type="checkbox" id="ws-active-toggle">
                <span class="toggle-track"></span>
                <span class="toggle-knob"></span>
              </label>
              <div>
                <div class="status-badge" id="ws-status-label">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
                <div style="font-size:.8rem;color:var(--text-muted);margin-top:2px">í™œì„±í™” ì‹œ Workshop í˜ì´ì§€ì— ì‹ ì²­ ì–‘ì‹ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
              </div>
            </div>

            <div class="form-inline">
              <div class="form-group"><label>Workshop ì œëª©</label><input class="form-control" id="ws-title"></div>
              <div class="form-group"><label>ë‚ ì§œ</label><input class="form-control" id="ws-date" placeholder="ì˜ˆ: 2026ë…„ 3ì›” 15ì¼"></div>
              <div class="form-group"><label>ì¥ì†Œ</label><input class="form-control" id="ws-location"></div>
              <div class="form-group"><label>ì •ì› (ëª…)</label><input class="form-control" id="ws-capacity" type="number" min="1"></div>
            </div>
            <div class="form-group" style="margin-top:12px"><label>ì£¼ì œ</label><input class="form-control" id="ws-topic"></div>
            <div class="form-group" style="margin-top:12px"><label>ì„¤ëª…</label><textarea class="form-control" id="ws-description" rows="4"></textarea></div>
            <div class="form-group" style="margin-top:12px">
              <label>ëŒ€í‘œ ì‚¬ì§„</label>
              <input type="file" accept="image/*" id="ws-photo-input" style="display:block;margin-top:6px">
              <img id="ws-photo-preview" class="img-preview" style="display:none">
              <input type="hidden" id="ws-photo-data">
            </div>
          </div>

          <!-- Workshop registrations -->
          <div class="panel" style="margin-top:20px">
            <div class="panel-header"><h3>Workshop ì‹ ì²­ì</h3></div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>#</th><th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>ì†Œì†</th><th>ê²½ë ¥</th><th>ë‚ ì§œ</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="ws-reg-tbody"><tr><td colspan="8" style="text-align:center;padding:24px;color:var(--text-muted)">â€”</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- â”€â”€ Panel: Activity â”€â”€ -->
        <div id="panel-activity" class="admin-panel">
          <!-- Cards section -->
          <div class="panel">
            <div class="panel-header">
              <h3>ì¹´ë“œ ë‰´ìŠ¤ (í”„ë¡œê·¸ë¨ ì†Œê°œ)</h3>
              <button class="btn btn-primary btn-sm" onclick="openModal('card')">+ ì¶”ê°€</button>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>#</th><th>ì œëª©</th><th>ë‚ ì§œ</th><th>ìˆœì„œ</th><th>í™œì„±</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="cards-tbody"><tr><td colspan="6" style="text-align:center;padding:24px;color:var(--text-muted)">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- Sessions section -->
          <div class="panel" style="margin-top:20px">
            <div class="panel-header">
              <h3>ìŠ¤í„°ë”” ì„¸ì…˜</h3>
              <button class="btn btn-primary btn-sm" onclick="openModal('session')">+ ì¶”ê°€</button>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>#</th><th>ë‚ ì§œ</th><th>ì£¼ì œ</th><th>ë°œí‘œì</th><th>í˜•ì‹</th><th>ìë£Œ</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="sessions-tbody"><tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-muted)">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- â”€â”€ Panel: Members â”€â”€ -->
        <div id="panel-members" class="admin-panel">
          <div class="panel">
            <div class="panel-header">
              <h3>Members ê´€ë¦¬</h3>
              <button class="btn btn-primary btn-sm" onclick="openModal('member')">+ ì¶”ê°€</button>
            </div>
            <div class="filter-row">
              <select id="member-year-filter" onchange="loadMembersAdmin()">
                <option value="">ì „ì²´ ì—°ë„</option>
                <option value="2026">2026</option>
                <option value="2025">2025</option>
                <option value="2024">2024</option>
              </select>
              <select id="member-cat-filter" onchange="loadMembersAdmin()">
                <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                <option value="current">í˜„ì¬ íšŒì›</option>
                <option value="alumni">ì—­ëŒ€ íšŒì›</option>
              </select>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>#</th><th>ì´ë¦„</th><th>ì§í•¨</th><th>ì†Œì†</th><th>ì—°ë„</th><th>ì¹´í…Œê³ ë¦¬</th><th>í™œì„±</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="members-tbody"><tr><td colspan="8" style="text-align:center;padding:24px;color:var(--text-muted)">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- â”€â”€ Panel: News â”€â”€ -->
        <div id="panel-news" class="admin-panel">
          <div class="panel">
            <div class="panel-header">
              <h3>News / ê³µì§€ì‚¬í•­</h3>
              <button class="btn btn-primary btn-sm" onclick="openModal('news')">+ ì‘ì„±</button>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>#</th><th>ì œëª©</th><th>ì¹´í…Œê³ ë¦¬</th><th>ë‚ ì§œ</th><th>ê³µê°œ</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="news-tbody"><tr><td colspan="6" style="text-align:center;padding:24px;color:var(--text-muted)">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- â”€â”€ Panel: Sponsors â”€â”€ -->
        <div id="panel-sponsors" class="admin-panel">
          <div class="panel">
            <div class="panel-header">
              <h3>Sponsor ê´€ë¦¬</h3>
              <button class="btn btn-primary btn-sm" onclick="openModal('sponsor')">+ ì¶”ê°€</button>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>#</th><th>ë¡œê³ </th><th>ì´ë¦„</th><th>ì›¹ì‚¬ì´íŠ¸</th><th>ìˆœì„œ</th><th>í™œì„±</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="sponsors-tbody"><tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-muted)">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- â”€â”€ Panel: Messages â”€â”€ -->
        <div id="panel-messages" class="admin-panel">
          <div class="panel">
            <div class="panel-header"><h3>ë©”ì‹œì§€í•¨</h3><button class="btn btn-dark btn-sm" onclick="loadMessages()">ìƒˆë¡œê³ ì¹¨</button></div>
            <div id="messages-list"><div style="text-align:center;padding:32px;color:var(--text-muted)">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div></div>
          </div>
        </div>

        <!-- â”€â”€ Panel: Settings â”€â”€ -->
        <div id="panel-settings" class="admin-panel">
          <div class="panel">
            <div class="panel-header"><h3>ì‚¬ì´íŠ¸ ì„¤ì •</h3></div>
            <div style="margin-bottom:24px">
              <h4 style="margin-bottom:12px">Study ì‹ ì²­(Registration) í™œì„±í™”</h4>
              <div class="reg-status-toggle" id="reg-toggle-wrap">
                <label class="toggle-pill">
                  <input type="checkbox" id="reg-open-toggle">
                  <span class="toggle-track"></span>
                  <span class="toggle-knob"></span>
                </label>
                <div>
                  <div class="status-badge" id="reg-status-label"></div>
                  <div style="font-size:.8rem;color:var(--text-muted);margin-top:2px">ìŠ¤í„°ë”” Registration ì‹ ì²­ í™œì„±í™” ì—¬ë¶€ì…ë‹ˆë‹¤.</div>
                </div>
              </div>
            </div>
            <hr class="form-divider">
            <div id="settings-form">
              <div class="setting-row"><label style="font-weight:500">ì‚¬ì´íŠ¸ ì´ë¦„</label><input class="form-control" id="s-site_name"></div>
              <div class="setting-row"><label style="font-weight:500">ìŠ¤í„°ë”” ìµœëŒ€ ì •ì›</label><input class="form-control" id="s-max_capacity" type="number"></div>
            </div>
            <div style="margin-top:20px;display:flex;gap:10px">
              <button class="btn btn-primary" onclick="saveSettings()">ì„¤ì • ì €ì¥</button>
              <button class="btn btn-dark" onclick="loadSettings()">ì´ˆê¸°í™”</button>
            </div>
          </div>
        </div>

      </div><!-- /main-panel -->
    </div><!-- /admin-layout -->
  </div>
</section>

<!-- â”€â”€ Modal â”€â”€ -->
<div id="modal-overlay" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeModal()">
  <div class="modal-box">
    <h3 id="modal-title">ì¶”ê°€</h3>
    <div id="modal-body"></div>
    <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
      <button class="btn btn-dark" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn btn-primary" id="modal-save-btn" onclick="modalSave()">ì €ì¥</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script src="../js/theme.js"></script>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILITIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function toast(msg,type='success'){
  const el=document.getElementById('toast');
  el.textContent=(type==='success'?'âœ… ':'âŒ ')+msg;
  el.className='show';
  setTimeout(()=>el.className='',2800);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function authCheck(){
  const res=await fetch('/api/admin/settings').catch(()=>null);
  if(!res||res.status===401) window.location.href='/admin/login.html';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const panelLoaders = {
  'panel-registrations': ()=>{ loadRegistrations(); loadKPI(); },
  'panel-workshop':      ()=>{ loadWorkshop(); },
  'panel-activity':      ()=>{ loadCards(); loadSessions(); },
  'panel-members':       ()=>{ loadMembersAdmin(); },
  'panel-news':          ()=>{ loadNewsAdmin(); },
  'panel-sponsors':      ()=>{ loadSponsors(); },
  'panel-messages':      ()=>{ loadMessages(); },
  'panel-settings':      ()=>{ loadSettings(); },
};

document.querySelectorAll('.sidebar-link[data-panel]').forEach(link=>{
  link.addEventListener('click',()=>{
    document.querySelectorAll('.sidebar-link').forEach(l=>l.classList.remove('active'));
    document.querySelectorAll('.admin-panel').forEach(p=>p.classList.remove('active'));
    link.classList.add('active');
    const panel = document.getElementById(link.dataset.panel);
    panel.classList.add('active');
    if(panelLoaders[link.dataset.panel]) panelLoaders[link.dataset.panel]();
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('logout-btn').addEventListener('click',async()=>{
  await fetch('/api/auth/logout',{method:'POST'});
  window.location.href='/admin/login.html';
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KPI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadKPI(){
  const [regsRes, msgsRes] = await Promise.all([
    fetch('/api/admin/registrations').catch(()=>null),
    fetch('/api/admin/messages').catch(()=>null)
  ]);
  if(regsRes&&regsRes.ok){
    const {registrations}=await regsRes.json();
    const all=registrations||[];
    document.getElementById('kpi-total').textContent=all.length;
    document.getElementById('kpi-study').textContent=all.filter(r=>r.type==='study').length;
    document.getElementById('kpi-workshop').textContent=all.filter(r=>r.type==='workshop').length;
  }
  if(msgsRes&&msgsRes.ok){
    const {messages}=await msgsRes.json();
    document.getElementById('kpi-messages').textContent=(messages||[]).filter(m=>!m.is_read).length;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REGISTRATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let allRows=[];
const typeLabel={study:'ìŠ¤í„°ë””',symposium:'ì‹¬í¬ì§€ì—„',workshop:'ì›Œí¬ìƒµ'};
const statusBadge={
  pending:'<span class="badge badge-warning">ê²€í†  ì¤‘</span>',
  approved:'<span class="badge badge-success">ìŠ¹ì¸ë¨</span>',
  rejected:'<span class="badge badge-danger">ê±°ì ˆë¨</span>'
};

async function loadRegistrations(){
  const type=document.getElementById('filter-type').value;
  const status=document.getElementById('filter-status').value;
  const tbody=document.getElementById('reg-tbody');
  tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:24px;color:var(--text-muted)">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>';
  const res=await fetch(`/api/admin/registrations?type=${type}&status=${status}`).catch(()=>null);
  if(!res||!res.ok){ tbody.innerHTML='<tr><td colspan="8" style="text-align:center;color:var(--danger)">ë¡œë“œ ì‹¤íŒ¨</td></tr>'; return; }
  const {registrations}=await res.json();
  allRows=registrations||[];
  renderRegTable(allRows);
}

function filterTable(){
  const q=document.getElementById('reg-search').value.toLowerCase();
  renderRegTable(allRows.filter(r=>(r.name||'').toLowerCase().includes(q)));
}

function renderRegTable(rows){
  const tbody=document.getElementById('reg-tbody');
  if(!rows.length){ tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:24px;color:var(--text-muted)">ì‹ ì²­ ë‚´ì—­ ì—†ìŒ</td></tr>'; return; }
  tbody.innerHTML=rows.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td><span class="badge badge-info">${typeLabel[r.type]||r.type}</span></td>
      <td>${esc(r.name)}</td>
      <td style="font-size:.82rem">${esc(r.phone||r.email)}</td>
      <td style="font-size:.82rem">${esc(r.affiliation)}</td>
      <td style="font-size:.82rem">${(r.created_at||'').slice(0,10)}</td>
      <td>${statusBadge[r.status]||r.status}</td>
      <td><div class="table-actions">
        <button onclick="setRegStatus(${r.id},'approved')" title="ìŠ¹ì¸">âœ…</button>
        <button onclick="setRegStatus(${r.id},'rejected')" title="ê±°ì ˆ">âŒ</button>
        <button onclick="setRegStatus(${r.id},'pending')"  title="ê²€í† ì¤‘">â³</button>
        <button onclick="delReg(${r.id})" title="ì‚­ì œ" style="color:var(--danger)">ğŸ—‘</button>
      </div></td>
    </tr>
  `).join('');
}

async function setRegStatus(id,status){
  const res=await fetch('/api/admin/registrations',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,status})});
  if(res.ok){ toast('ìƒíƒœ ë³€ê²½ë¨'); loadRegistrations(); loadKPI(); }
  else toast('ë³€ê²½ ì‹¤íŒ¨','error');
}

async function delReg(id){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const res=await fetch('/api/admin/registrations?id='+id,{method:'DELETE'});
  if(res.ok){ toast('ì‚­ì œë¨'); loadRegistrations(); loadKPI(); }
  else toast('ì‚­ì œ ì‹¤íŒ¨','error');
}

function exportCSV(){
  if(!allRows.length){ toast('ë‚´ë³´ë‚¼ ë°ì´í„° ì—†ìŒ','error'); return; }
  const header=['ID','ìœ í˜•','ì´ë¦„','ì—°ë½ì²˜','ì†Œì†','ë‚ ì§œ','ìƒíƒœ'];
  const rows=allRows.map(r=>[r.id,typeLabel[r.type]||r.type,r.name,r.phone||r.email,r.affiliation,(r.created_at||'').slice(0,10),r.status].map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','));
  const csv=[header.join(','),...rows].join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,\uFEFF'+encodeURIComponent(csv);
  a.download=`registrations_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WORKSHOP CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadWorkshop(){
  const res=await fetch('/api/admin/workshop').catch(()=>null);
  if(!res||!res.ok) return;
  const {config,registrations}=await res.json();

  document.getElementById('ws-active-toggle').checked=!!config.active;
  updateWsLabel(!!config.active);
  document.getElementById('ws-title').value=config.title||'';
  document.getElementById('ws-date').value=config.date||'';
  document.getElementById('ws-location').value=config.location||'';
  document.getElementById('ws-capacity').value=config.capacity||'';
  document.getElementById('ws-topic').value=config.topic||'';
  document.getElementById('ws-description').value=config.description||'';

  const preview=document.getElementById('ws-photo-preview');
  if(config.photo){ preview.src=config.photo; preview.style.display=''; }
  else preview.style.display='none';
  document.getElementById('ws-photo-data').value=config.photo||'';

  // Workshop registrations table
  const tbody=document.getElementById('ws-reg-tbody');
  const regs=registrations||[];
  if(!regs.length){
    tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:24px;color:var(--text-muted)">ì‹ ì²­ì ì—†ìŒ</td></tr>';
    return;
  }
  tbody.innerHTML=regs.map((r,i)=>{
    const data=r.data?JSON.parse(r.data):{};
    return `<tr>
      <td>${i+1}</td>
      <td>${esc(r.name)}</td>
      <td style="font-size:.82rem">${esc(r.phone)}</td>
      <td style="font-size:.82rem">${esc(r.affiliation)}</td>
      <td style="font-size:.82rem">${esc(data.experience||'')}</td>
      <td style="font-size:.82rem">${(r.created_at||'').slice(0,10)}</td>
      <td>${statusBadge[r.status]||r.status}</td>
      <td><div class="table-actions">
        <button onclick="setRegStatus(${r.id},'approved')" title="ìŠ¹ì¸">âœ…</button>
        <button onclick="setRegStatus(${r.id},'rejected')" title="ê±°ì ˆ">âŒ</button>
        <button onclick="delWsReg(${r.id})" title="ì‚­ì œ" style="color:var(--danger)">ğŸ—‘</button>
      </div></td>
    </tr>`;
  }).join('');
}

function updateWsLabel(active){
  document.getElementById('ws-status-label').textContent=active?'âœ… Workshop ëª¨ì§‘ ì¤‘':'ğŸ”’ Workshop ë¹„í™œì„±í™”';
}

document.getElementById('ws-active-toggle').addEventListener('change',function(){
  updateWsLabel(this.checked);
});

// Image preview for workshop
document.getElementById('ws-photo-input').addEventListener('change',function(){
  const file=this.files[0];
  if(!file) return;
  resizeImage(file,800,600,(b64)=>{
    document.getElementById('ws-photo-data').value=b64;
    const preview=document.getElementById('ws-photo-preview');
    preview.src=b64;
    preview.style.display='';
  });
});

async function saveWorkshop(){
  const body={
    ws_active: document.getElementById('ws-active-toggle').checked?'true':'false',
    ws_title:  document.getElementById('ws-title').value,
    ws_date:   document.getElementById('ws-date').value,
    ws_location: document.getElementById('ws-location').value,
    ws_capacity: document.getElementById('ws-capacity').value,
    ws_topic:    document.getElementById('ws-topic').value,
    ws_description: document.getElementById('ws-description').value,
  };
  const photo=document.getElementById('ws-photo-data').value;
  if(photo) body.ws_photo=photo;

  const res=await fetch('/api/admin/workshop',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(res.ok) toast('Workshop ì„¤ì • ì €ì¥ë¨');
  else toast('ì €ì¥ ì‹¤íŒ¨','error');
}

async function delWsReg(id){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const res=await fetch('/api/admin/workshop?reg_id='+id,{method:'DELETE'});
  if(res.ok){ toast('ì‚­ì œë¨'); loadWorkshop(); }
  else toast('ì‚­ì œ ì‹¤íŒ¨','error');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTIVITY â€“ CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadCards(){
  const res=await fetch('/api/admin/activity?type=cards').catch(()=>null);
  if(!res||!res.ok) return;
  const {cards}=await res.json();
  const tbody=document.getElementById('cards-tbody');
  if(!cards||!cards.length){
    tbody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--text-muted)">ì¹´ë“œ ì—†ìŒ</td></tr>';
    return;
  }
  tbody.innerHTML=cards.map((c,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${esc(c.title)}</td>
      <td style="font-size:.82rem">${esc(c.date)}</td>
      <td>${c.order_num}</td>
      <td>${c.active?'âœ…':'â€”'}</td>
      <td><div class="table-actions">
        <button onclick="editCard(${JSON.stringify(c).replace(/'/g,"&#39;")})">âœï¸</button>
        <button onclick="delCard(${c.id})" style="color:var(--danger)">ğŸ—‘</button>
      </div></td>
    </tr>
  `).join('');
}

async function delCard(id){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await fetch('/api/admin/activity?type=cards&id='+id,{method:'DELETE'});
  toast('ì‚­ì œë¨'); loadCards();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTIVITY â€“ SESSIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadSessions(){
  const res=await fetch('/api/admin/activity?type=sessions').catch(()=>null);
  if(!res||!res.ok) return;
  const {sessions}=await res.json();
  const tbody=document.getElementById('sessions-tbody');
  if(!sessions||!sessions.length){
    tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-muted)">ì„¸ì…˜ ì—†ìŒ</td></tr>';
    return;
  }
  tbody.innerHTML=sessions.map((s,i)=>`
    <tr>
      <td>${i+1}</td>
      <td style="font-size:.82rem">${esc(s.session_date)}</td>
      <td>${esc(s.title)}</td>
      <td style="font-size:.82rem">${esc(s.presenter)}</td>
      <td style="font-size:.82rem">${esc(s.format)}</td>
      <td>${s.has_material?'âœ…':'â€”'}</td>
      <td><div class="table-actions">
        <button onclick="editSession(${JSON.stringify(s).replace(/'/g,"&#39;")})">âœï¸</button>
        <button onclick="delSession(${s.id})" style="color:var(--danger)">ğŸ—‘</button>
      </div></td>
    </tr>
  `).join('');
}

async function delSession(id){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await fetch('/api/admin/activity?type=sessions&id='+id,{method:'DELETE'});
  toast('ì‚­ì œë¨'); loadSessions();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MEMBERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadMembersAdmin(){
  const year=document.getElementById('member-year-filter').value;
  const cat=document.getElementById('member-cat-filter').value;
  const res=await fetch('/api/admin/members-list').catch(()=>null);
  if(!res||!res.ok) return;
  const {members}=await res.json();
  let rows=members||[];
  if(year) rows=rows.filter(m=>m.year==year);
  if(cat)  rows=rows.filter(m=>m.category==cat);
  const tbody=document.getElementById('members-tbody');
  if(!rows.length){
    tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:24px;color:var(--text-muted)">íšŒì› ì—†ìŒ</td></tr>';
    return;
  }
  tbody.innerHTML=rows.map((m,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${esc(m.name)}</td>
      <td style="font-size:.82rem">${esc(m.title)}</td>
      <td style="font-size:.82rem">${esc(m.workplace)}</td>
      <td>${m.year||''}</td>
      <td>${m.category==='current'?'í˜„ì¬':'ì—­ëŒ€'}</td>
      <td>${m.active?'âœ…':'â€”'}</td>
      <td><div class="table-actions">
        <button onclick="editMember(${JSON.stringify(m).replace(/'/g,"&#39;")})">âœï¸</button>
        <button onclick="delMember(${m.id})" style="color:var(--danger)">ğŸ—‘</button>
      </div></td>
    </tr>
  `).join('');
}

async function delMember(id){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await fetch('/api/admin/members-list?id='+id,{method:'DELETE'});
  toast('ì‚­ì œë¨'); loadMembersAdmin();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEWS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadNewsAdmin(){
  const res=await fetch('/api/admin/news').catch(()=>null);
  if(!res||!res.ok) return;
  const {news}=await res.json();
  const tbody=document.getElementById('news-tbody');
  if(!news||!news.length){
    tbody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--text-muted)">ê³µì§€ ì—†ìŒ</td></tr>';
    return;
  }
  tbody.innerHTML=news.map((n,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${esc(n.title)}</td>
      <td><span class="badge badge-info">${esc(n.category)}</span></td>
      <td style="font-size:.82rem">${(n.created_at||'').slice(0,10)}</td>
      <td>${n.published?'âœ…':'â€”'}</td>
      <td><div class="table-actions">
        <button onclick="editNews(${JSON.stringify(n).replace(/'/g,"&#39;")})">âœï¸</button>
        <button onclick="toggleNews(${n.id},${n.published?0:1})">${n.published?'ìˆ¨ê¸°ê¸°':'ê³µê°œ'}</button>
        <button onclick="delNews(${n.id})" style="color:var(--danger)">ğŸ—‘</button>
      </div></td>
    </tr>
  `).join('');
}

async function toggleNews(id,published){
  await fetch('/api/admin/news',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,published:!!published})});
  toast('ë³€ê²½ë¨'); loadNewsAdmin();
}

async function delNews(id){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await fetch('/api/admin/news?id='+id,{method:'DELETE'});
  toast('ì‚­ì œë¨'); loadNewsAdmin();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPONSORS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadSponsors(){
  const res=await fetch('/api/admin/sponsors').catch(()=>null);
  if(!res||!res.ok) return;
  const {sponsors}=await res.json();
  const tbody=document.getElementById('sponsors-tbody');
  if(!sponsors||!sponsors.length){
    tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-muted)">í›„ì›ì‚¬ ì—†ìŒ</td></tr>';
    return;
  }
  tbody.innerHTML=sponsors.map((s,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${s.logo?`<img src="${esc(s.logo)}" style="height:36px;width:auto;max-width:80px;object-fit:contain;">`:'â€”'}</td>
      <td>${esc(s.name)}</td>
      <td style="font-size:.82rem">${s.website?`<a href="${esc(s.website)}" target="_blank">${esc(s.website)}</a>`:'â€”'}</td>
      <td>${s.order_num}</td>
      <td>${s.active?'âœ…':'â€”'}</td>
      <td><div class="table-actions">
        <button onclick="editSponsor(${JSON.stringify(s).replace(/'/g,"&#39;")})">âœï¸</button>
        <button onclick="delSponsor(${s.id})" style="color:var(--danger)">ğŸ—‘</button>
      </div></td>
    </tr>
  `).join('');
}

async function delSponsor(id){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await fetch('/api/admin/sponsors?id='+id,{method:'DELETE'});
  toast('ì‚­ì œë¨'); loadSponsors();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MESSAGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadMessages(){
  const res=await fetch('/api/admin/messages').catch(()=>null);
  if(!res||!res.ok) return;
  const {messages}=await res.json();
  const list=document.getElementById('messages-list');
  if(!messages||!messages.length){
    list.innerHTML='<div style="text-align:center;padding:32px;color:var(--text-muted)">ë©”ì‹œì§€ ì—†ìŒ</div>';
    return;
  }
  list.innerHTML=messages.map(m=>`
    <div class="message-card ${m.is_read?'':'unread'}" id="msg-${m.id}">
      <div class="message-meta">
        <strong>${esc(m.name)}</strong>
        <span>ğŸ“ ${esc(m.phone)}</span>
        ${m.subject?`<span>ğŸ“Œ ${esc(m.subject)}</span>`:''}
        <span>${(m.created_at||'').slice(0,16).replace('T',' ')}</span>
        ${m.is_read?'':'<span style="color:var(--primary);font-weight:600">NEW</span>'}
      </div>
      <div class="message-body">${esc(m.message)}</div>
      <div class="table-actions" style="margin-top:12px">
        ${!m.is_read?`<button onclick="markRead(${m.id})">âœ… ì½ìŒ í‘œì‹œ</button>`:''}
        <button onclick="delMsg(${m.id})" style="color:var(--danger)">ğŸ—‘ ì‚­ì œ</button>
      </div>
    </div>
  `).join('');
  loadKPI();
}

async function markRead(id){
  await fetch('/api/admin/messages',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
  toast('ì½ìŒ ì²˜ë¦¬ë¨'); loadMessages();
}

async function delMsg(id){
  if(!confirm('ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  await fetch('/api/admin/messages?id='+id,{method:'DELETE'});
  toast('ì‚­ì œë¨'); loadMessages();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadSettings(){
  const res=await fetch('/api/admin/settings').catch(()=>null);
  if(!res||!res.ok) return;
  const {settings}=await res.json();
  const map={};
  (settings||[]).forEach(s=>map[s.key]=s.value);
  const isOpen=map.reg_open==='true';
  document.getElementById('reg-open-toggle').checked=isOpen;
  updateRegLabel(isOpen);
  ['site_name','max_capacity'].forEach(k=>{
    const el=document.getElementById('s-'+k);
    if(el) el.value=map[k]||'';
  });
}

function updateRegLabel(open){
  const lbl=document.getElementById('reg-status-label');
  const wrap=document.getElementById('reg-toggle-wrap');
  lbl.textContent=open?'âœ… ì‹ ì²­ í™œì„±í™” (ëª¨ì§‘ ì¤‘)':'ğŸ”’ ì‹ ì²­ ë¹„í™œì„±í™” (ëª¨ì§‘ ì¢…ë£Œ)';
  wrap.className='reg-status-toggle '+(open?'reg-open':'reg-close');
}

document.getElementById('reg-open-toggle').addEventListener('change',async function(){
  const open=this.checked;
  updateRegLabel(open);
  const res=await fetch('/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({reg_open:open?'true':'false'})});
  if(res.ok) toast(open?'ì‹ ì²­ í™œì„±í™”ë¨':'ì‹ ì²­ ë¹„í™œì„±í™”ë¨');
  else{ toast('ì €ì¥ ì‹¤íŒ¨','error'); this.checked=!open; updateRegLabel(!open); }
});

async function saveSettings(){
  const body={};
  ['site_name','max_capacity'].forEach(k=>{ const el=document.getElementById('s-'+k); if(el) body[k]=el.value; });
  const res=await fetch('/api/admin/settings',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(res.ok) toast('ì„¤ì • ì €ì¥ë¨');
  else toast('ì €ì¥ ì‹¤íŒ¨','error');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let modalType='', modalData=null;

function openModal(type, data=null){
  modalType=type; modalData=data;
  const overlay=document.getElementById('modal-overlay');
  const title=document.getElementById('modal-title');
  const body=document.getElementById('modal-body');
  overlay.style.display='flex';

  if(type==='card'){
    title.textContent=(data?'ì¹´ë“œ ìˆ˜ì •':'ì¹´ë“œ ì¶”ê°€');
    body.innerHTML=`
      <div class="form-group"><label>ì œëª©</label><input class="form-control" id="m-title" value="${esc(data?.title||'')}"></div>
      <div class="form-group"><label>ì„¤ëª…</label><textarea class="form-control" id="m-description" rows="3">${esc(data?.description||'')}</textarea></div>
      <div class="form-group"><label>ë‚ ì§œ</label><input class="form-control" id="m-date" value="${esc(data?.date||'')}"></div>
      <div class="form-group"><label>ìˆœì„œ</label><input class="form-control" id="m-order_num" type="number" value="${data?.order_num||0}"></div>
      <div class="form-group"><label>ì´ë¯¸ì§€ ì—…ë¡œë“œ</label><input type="file" accept="image/*" id="m-img-input" style="display:block;margin-top:6px"><input type="hidden" id="m-image" value="${esc(data?.image||'')}">
        ${data?.image?`<img src="${esc(data.image)}" class="img-preview">`:''}
      </div>`;
    document.getElementById('m-img-input').addEventListener('change',function(){
      const file=this.files[0]; if(!file) return;
      resizeImage(file,800,600,(b64)=>{ document.getElementById('m-image').value=b64; });
    });
  } else if(type==='session'){
    title.textContent=(data?'ì„¸ì…˜ ìˆ˜ì •':'ì„¸ì…˜ ì¶”ê°€');
    body.innerHTML=`
      <div class="form-inline">
        <div class="form-group"><label>ë‚ ì§œ</label><input class="form-control" id="m-session_date" type="date" value="${esc(data?.session_date||'')}"></div>
        <div class="form-group"><label>í˜•ì‹</label><select class="form-control" id="m-format">
          ${['ì¼€ì´ìŠ¤ ë°œí‘œ','ì„¸ë¯¸ë‚˜','ì‹¤ìŠµ','ê²ŒìŠ¤íŠ¸ ê°•ì‚¬','ê¸°íƒ€'].map(f=>`<option${data?.format===f?' selected':''}>${f}</option>`).join('')}
        </select></div>
      </div>
      <div class="form-group"><label>ì£¼ì œ</label><input class="form-control" id="m-title" value="${esc(data?.title||'')}"></div>
      <div class="form-group"><label>ë°œí‘œì</label><input class="form-control" id="m-presenter" value="${esc(data?.presenter||'')}"></div>
      <div class="form-group"><label>ìˆœì„œ</label><input class="form-control" id="m-order_num" type="number" value="${data?.order_num||0}"></div>
      <div class="form-group"><label class="check-item"><input type="checkbox" id="m-has_material" ${data?.has_material?'checked':''}> <span>ìë£Œ ìˆìŒ</span></label></div>`;
  } else if(type==='member'){
    title.textContent=(data?'íšŒì› ìˆ˜ì •':'íšŒì› ì¶”ê°€');
    body.innerHTML=`
      <div class="form-inline">
        <div class="form-group"><label>ì´ë¦„</label><input class="form-control" id="m-name" value="${esc(data?.name||'')}"></div>
        <div class="form-group"><label>ì§í•¨</label><input class="form-control" id="m-title" value="${esc(data?.title||'')}"></div>
      </div>
      <div class="form-group"><label>ì†Œì†</label><input class="form-control" id="m-workplace" value="${esc(data?.workplace||'')}"></div>
      <div class="form-group"><label>ì´ë ¥/ì†Œê°œ</label><textarea class="form-control" id="m-bio" rows="3">${esc(data?.bio||'')}</textarea></div>
      <div class="form-inline">
        <div class="form-group"><label>ì—°ë„</label><input class="form-control" id="m-year" value="${data?.year||'2026'}"></div>
        <div class="form-group"><label>ì¹´í…Œê³ ë¦¬</label><select class="form-control" id="m-category">
          <option value="current"${data?.category==='current'?' selected':''}>í˜„ì¬ íšŒì›</option>
          <option value="alumni"${data?.category==='alumni'?' selected':''}>ì—­ëŒ€ íšŒì›</option>
        </select></div>
      </div>
      <div class="form-group"><label>ì›¹í˜ì´ì§€ URL</label><input class="form-control" id="m-webpage" value="${esc(data?.webpage||'')}"></div>
      <div class="form-group"><label>ìˆœì„œ</label><input class="form-control" id="m-order_num" type="number" value="${data?.order_num||0}"></div>
      <div class="form-group"><label>í”„ë¡œí•„ ì‚¬ì§„</label><input type="file" accept="image/*" id="m-photo-input" style="display:block;margin-top:6px"><input type="hidden" id="m-photo" value="${esc(data?.photo||'')}">
        ${data?.photo?`<img src="${esc(data.photo)}" class="img-preview">`:''}
      </div>
      <div class="form-group"><label>Artwork ì´ë¯¸ì§€</label><input type="file" accept="image/*" id="m-artwork-input" style="display:block;margin-top:6px"><input type="hidden" id="m-artwork" value="${esc(data?.artwork||'')}">
        ${data?.artwork?`<img src="${esc(data.artwork)}" class="img-preview">`:''}
      </div>`;
    document.getElementById('m-photo-input').addEventListener('change',function(){
      resizeImage(this.files[0],400,400,(b64)=>{ document.getElementById('m-photo').value=b64; });
    });
    document.getElementById('m-artwork-input').addEventListener('change',function(){
      resizeImage(this.files[0],800,600,(b64)=>{ document.getElementById('m-artwork').value=b64; });
    });
  } else if(type==='news'){
    title.textContent=(data?'ê³µì§€ ìˆ˜ì •':'ê³µì§€ ì‘ì„±');
    body.innerHTML=`
      <div class="form-group"><label>ì œëª©</label><input class="form-control" id="m-title" value="${esc(data?.title||'')}"></div>
      <div class="form-group"><label>ì¹´í…Œê³ ë¦¬</label><select class="form-control" id="m-category">
        ${['ê³µì§€','í–‰ì‚¬','ì›Œí¬ìƒµ','ì†Œì‹'].map(c=>`<option${data?.category===c?' selected':''}>${c}</option>`).join('')}
      </select></div>
      <div class="form-group"><label>ë‚´ìš©</label><textarea class="form-control" id="m-content" rows="6">${esc(data?.content||'')}</textarea></div>
      <div class="form-group"><label class="check-item"><input type="checkbox" id="m-published" ${!data||data.published?'checked':''}> <span>ì¦‰ì‹œ ê³µê°œ</span></label></div>`;
  } else if(type==='sponsor'){
    title.textContent=(data?'í›„ì›ì‚¬ ìˆ˜ì •':'í›„ì›ì‚¬ ì¶”ê°€');
    body.innerHTML=`
      <div class="form-group"><label>ì´ë¦„</label><input class="form-control" id="m-name" value="${esc(data?.name||'')}"></div>
      <div class="form-group"><label>ì›¹ì‚¬ì´íŠ¸ URL</label><input class="form-control" id="m-website" value="${esc(data?.website||'')}"></div>
      <div class="form-group"><label>ìˆœì„œ</label><input class="form-control" id="m-order_num" type="number" value="${data?.order_num||0}"></div>
      <div class="form-group"><label>ë¡œê³  ì´ë¯¸ì§€</label><input type="file" accept="image/*" id="m-logo-input" style="display:block;margin-top:6px"><input type="hidden" id="m-logo" value="${esc(data?.logo||'')}">
        ${data?.logo?`<img src="${esc(data.logo)}" class="img-preview">`:''}
      </div>`;
    document.getElementById('m-logo-input').addEventListener('change',function(){
      resizeImage(this.files[0],400,200,(b64)=>{ document.getElementById('m-logo').value=b64; });
    });
  }
}

function closeModal(){
  document.getElementById('modal-overlay').style.display='none';
  modalType=''; modalData=null;
}

async function modalSave(){
  const data=modalData;
  const isEdit=!!data;
  let body={};
  let url='', method='';

  if(modalType==='card'){
    body={ title:val('m-title'),description:val('m-description'),date:val('m-date'),order_num:parseInt(val('m-order_num'))||0,image:val('m-image') };
    if(isEdit){ body.id=data.id; body.type='card'; url='/api/admin/activity'; method='PATCH'; }
    else{ body.type='card'; url='/api/admin/activity'; method='POST'; }
  } else if(modalType==='session'){
    body={ session_date:val('m-session_date'),title:val('m-title'),presenter:val('m-presenter'),format:val('m-format'),has_material:document.getElementById('m-has_material').checked,order_num:parseInt(val('m-order_num'))||0 };
    if(isEdit){ body.id=data.id; body.type='session'; url='/api/admin/activity'; method='PATCH'; }
    else{ body.type='session'; url='/api/admin/activity'; method='POST'; }
  } else if(modalType==='member'){
    body={ name:val('m-name'),title:val('m-title'),workplace:val('m-workplace'),bio:val('m-bio'),year:val('m-year'),category:val('m-category'),webpage:val('m-webpage'),order_num:parseInt(val('m-order_num'))||0,photo:val('m-photo'),artwork:val('m-artwork') };
    if(isEdit){ body.id=data.id; url='/api/admin/members-list'; method='PATCH'; }
    else{ url='/api/admin/members-list'; method='POST'; }
  } else if(modalType==='news'){
    body={ title:val('m-title'),content:val('m-content'),category:val('m-category'),published:document.getElementById('m-published').checked };
    if(isEdit){ body.id=data.id; url='/api/admin/news'; method='PATCH'; }
    else{ url='/api/admin/news'; method='POST'; }
  } else if(modalType==='sponsor'){
    body={ name:val('m-name'),website:val('m-website'),order_num:parseInt(val('m-order_num'))||0,logo:val('m-logo') };
    if(isEdit){ body.id=data.id; url='/api/admin/sponsors'; method='PATCH'; }
    else{ url='/api/admin/sponsors'; method='POST'; }
  }

  const res=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(res.ok){
    toast(isEdit?'ìˆ˜ì •ë¨':'ì¶”ê°€ë¨');
    closeModal();
    const reloader={card:()=>loadCards(),session:()=>loadSessions(),member:()=>loadMembersAdmin(),news:()=>loadNewsAdmin(),sponsor:()=>loadSponsors()};
    if(reloader[modalType]) reloader[modalType]();
  } else {
    toast('ì €ì¥ ì‹¤íŒ¨','error');
  }
}

function val(id){ const el=document.getElementById(id); return el?el.value:''; }

function editCard(c){ openModal('card',typeof c==='string'?JSON.parse(c):c); }
function editSession(s){ openModal('session',typeof s==='string'?JSON.parse(s):s); }
function editMember(m){ openModal('member',typeof m==='string'?JSON.parse(m):m); }
function editNews(n){ openModal('news',typeof n==='string'?JSON.parse(n):n); }
function editSponsor(s){ openModal('sponsor',typeof s==='string'?JSON.parse(s):s); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMAGE RESIZE HELPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function resizeImage(file,maxW,maxH,cb){
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      let {width:w,height:h}=img;
      if(w>maxW){ h=Math.round(h*maxW/w); w=maxW; }
      if(h>maxH){ w=Math.round(w*maxH/h); h=maxH; }
      const canvas=document.createElement('canvas');
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      cb(canvas.toDataURL('image/jpeg',0.82));
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(async()=>{
  await authCheck();
  loadKPI();
  loadRegistrations();
})();
</script>
</body>
</html>
