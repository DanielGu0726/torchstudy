<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ â€“ TORCH</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .admin-layout { display: grid; grid-template-columns: 220px 1fr; gap: 24px; align-items: start; }
    @media (max-width: 768px) { .admin-layout { grid-template-columns: 1fr; } }
    .reg-status-toggle { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--light); border-radius: var(--radius); border: 1.5px solid var(--border); }
    .toggle-pill { position: relative; width: 52px; height: 28px; cursor: pointer; }
    .toggle-pill input { opacity: 0; width: 0; height: 0; }
    .toggle-track { position: absolute; inset: 0; border-radius: 14px; background: #ccc; transition: background .25s; }
    .toggle-knob  { position: absolute; top: 4px; left: 4px; width: 20px; height: 20px; background: #fff; border-radius: 50%; box-shadow: 0 1px 4px rgba(0,0,0,.25); transition: transform .25s; }
    .toggle-pill input:checked ~ .toggle-track { background: var(--primary); }
    .toggle-pill input:checked ~ .toggle-knob  { transform: translateX(24px); }
    .status-badge { font-size: .88rem; font-weight: 600; }
    .reg-open  .status-badge { color: var(--success); }
    .reg-close .status-badge { color: var(--text-muted); }
    .table-actions { display: flex; gap: 6px; }
    .table-actions button { padding: 4px 8px; font-size: .78rem; border-radius: 4px; border: 1px solid var(--border); background: var(--white); cursor: pointer; }
    .table-actions button:hover { background: var(--light); }
    .filter-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    .filter-row select { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: .85rem; background: var(--white); color: var(--text); }
    .setting-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .setting-row:last-child { border-bottom: none; }
    .setting-row input { max-width: 260px; }
    .setting-row select { max-width: 260px; }
    #toast { position: fixed; bottom: 24px; right: 24px; background: #1a1a2e; color: #fff; padding: 12px 20px; border-radius: 8px; font-size: .88rem; opacity: 0; transform: translateY(8px); transition: all .25s; pointer-events: none; z-index: 9999; }
    #toast.show { opacity: 1; transform: translateY(0); }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
  <div class="nav-inner">
    <a href="../index.html" class="nav-logo"><div class="logo-icon">ğŸ”¥</div>TORCH</a>
    <div class="nav-links">
      <div class="nav-item"><a href="../index.html" class="nav-link">ì‚¬ì´íŠ¸</a></div>
      <div class="nav-item"><a href="/admin/" class="nav-link active">Admin</a></div>
    </div>
    <div class="nav-cta">
      <button class="btn btn-outline btn-sm" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <div class="hamburger"><span></span><span></span><span></span></div>
  </div>
</nav>

<div class="page-header">
  <div class="container">
    <span class="eyebrow">Administration</span>
    <h1>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <p>ì‹ ì²­ í˜„í™©, íšŒì› ì •ë³´, ì‚¬ì´íŠ¸ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
  </div>
</div>

<section class="section section-light">
  <div class="container">

    <!-- KPI -->
    <div class="kpi-grid" style="margin-bottom:28px" id="kpi-grid">
      <div class="kpi-card"><div class="kpi-label">ì´ ì‹ ì²­</div><div class="kpi-value" id="kpi-total">â€”</div></div>
      <div class="kpi-card"><div class="kpi-label">ìŠ¤í„°ë””</div><div class="kpi-value" id="kpi-study">â€”</div></div>
      <div class="kpi-card"><div class="kpi-label">ì‹¬í¬ì§€ì—„</div><div class="kpi-value" id="kpi-symposium">â€”</div></div>
      <div class="kpi-card"><div class="kpi-label">ì›Œí¬ìƒµ</div><div class="kpi-value" id="kpi-workshop">â€”</div></div>
    </div>

    <div class="admin-layout">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-title">ëŒ€ì‹œë³´ë“œ</div>
        <div class="sidebar-link active" data-panel="panel-registrations">ğŸ“‹ ì‹ ì²­ ê´€ë¦¬</div>
        <div class="sidebar-title" style="margin-top:12px">ì„¤ì •</div>
        <div class="sidebar-link" data-panel="panel-settings">âš™ï¸ ì‚¬ì´íŠ¸ ì„¤ì •</div>
      </div>

      <!-- Main -->
      <div class="main-panel">

        <!-- Registrations Panel -->
        <div id="panel-registrations" class="admin-panel">
          <div class="panel">
            <div class="panel-header">
              <h3>ì‹ ì²­ ëª©ë¡</h3>
              <div style="display:flex;gap:8px">
                <button class="btn btn-primary btn-sm" onclick="exportCSV()">ğŸ“¥ CSV</button>
              </div>
            </div>

            <div class="filter-row">
              <select id="filter-type" onchange="loadRegistrations()">
                <option value="all">ì „ì²´ ìœ í˜•</option>
                <option value="study">ìŠ¤í„°ë””</option>
                <option value="symposium">ì‹¬í¬ì§€ì—„</option>
                <option value="workshop">ì›Œí¬ìƒµ</option>
              </select>
              <select id="filter-status" onchange="loadRegistrations()">
                <option value="all">ì „ì²´ ìƒíƒœ</option>
                <option value="pending">ê²€í†  ì¤‘</option>
                <option value="approved">ìŠ¹ì¸ë¨</option>
                <option value="rejected">ê±°ì ˆë¨</option>
              </select>
              <input class="form-control" id="reg-search" placeholder="ì´ë¦„/ì´ë©”ì¼ ê²€ìƒ‰â€¦"
                     style="max-width:200px;font-size:.85rem;padding:7px 12px"
                     oninput="filterTable()">
            </div>

            <div class="table-wrap">
              <table id="reg-table">
                <thead>
                  <tr><th>#</th><th>ìœ í˜•</th><th>ì´ë¦„</th><th>ì´ë©”ì¼</th><th>ì†Œì†</th><th>ë‚ ì§œ</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr>
                </thead>
                <tbody id="reg-tbody">
                  <tr><td colspan="8" style="text-align:center;padding:32px;color:var(--text-muted)">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Settings Panel -->
        <div id="panel-settings" class="admin-panel" style="display:none">
          <div class="panel">
            <div class="panel-header"><h3>ì‚¬ì´íŠ¸ ì„¤ì •</h3></div>

            <!-- Registration Open/Close -->
            <div style="margin-bottom:24px">
              <h4 style="margin-bottom:12px">ì‹ ì²­(Registration) í™œì„±í™”</h4>
              <div class="reg-status-toggle" id="reg-toggle-wrap">
                <label class="toggle-pill">
                  <input type="checkbox" id="reg-open-toggle">
                  <span class="toggle-track"></span>
                  <span class="toggle-knob"></span>
                </label>
                <div>
                  <div class="status-badge" id="reg-status-label"></div>
                  <div style="font-size:.8rem;color:var(--text-muted);margin-top:2px">ë¹„í™œì„±í™” ì‹œ Registration í˜ì´ì§€ì— "ëª¨ì§‘ ê¸°ê°„ ì•„ë‹˜" ì•ˆë‚´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
                </div>
              </div>
            </div>

            <hr class="form-divider">

            <!-- Other settings -->
            <div id="settings-form">
              <div class="setting-row">
                <label style="font-weight:500">ì‚¬ì´íŠ¸ ì´ë¦„</label>
                <input class="form-control" id="s-site_name">
              </div>
              <div class="setting-row">
                <label style="font-weight:500">ì—°ë½ì²˜ ì´ë©”ì¼</label>
                <input class="form-control" id="s-contact_email" type="email">
              </div>
              <div class="setting-row">
                <label style="font-weight:500">ìŠ¤í„°ë”” ìµœëŒ€ ì •ì›</label>
                <input class="form-control" id="s-max_capacity" type="number">
              </div>
            </div>

            <div style="margin-top:20px;display:flex;gap:10px">
              <button class="btn btn-primary" onclick="saveSettings()">ì„¤ì • ì €ì¥</button>
              <button class="btn btn-dark" onclick="loadSettings()">ì´ˆê¸°í™”</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</section>

<div id="toast"></div>

<script src="../js/theme.js"></script>
<script>
/* â”€â”€ Auth check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function authCheck() {
  const res = await fetch('/api/admin/settings').catch(() => null);
  if (!res || res.status === 401) {
    window.location.href = '/admin/login.html';
  }
}

/* â”€â”€ Sidebar nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.querySelectorAll('.sidebar-link[data-panel]').forEach(link => {
  link.addEventListener('click', () => {
    document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
    document.querySelectorAll('.admin-panel').forEach(p => p.style.display = 'none');
    link.classList.add('active');
    document.getElementById(link.dataset.panel).style.display = '';
    if (link.dataset.panel === 'panel-settings') loadSettings();
    if (link.dataset.panel === 'panel-registrations') loadRegistrations();
  });
});

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toast(msg, type = 'success') {
  const el = document.getElementById('toast');
  el.textContent = (type === 'success' ? 'âœ… ' : 'âŒ ') + msg;
  el.className = 'show';
  setTimeout(() => el.className = '', 2800);
}

/* â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('logout-btn').addEventListener('click', async () => {
  await fetch('/api/auth/logout', { method: 'POST' });
  window.location.href = '/admin/login.html';
});

/* â”€â”€ KPI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadKPI() {
  const res = await fetch('/api/admin/registrations').catch(() => null);
  if (!res || !res.ok) return;
  const { kpi } = await res.json();

  let total = 0;
  const map = {};
  (kpi || []).forEach(k => { map[k.type] = k.cnt; total += k.cnt; });

  document.getElementById('kpi-total').textContent     = total;
  document.getElementById('kpi-study').textContent     = map.study     || 0;
  document.getElementById('kpi-symposium').textContent = map.symposium || 0;
  document.getElementById('kpi-workshop').textContent  = map.workshop  || 0;
}

/* â”€â”€ Registrations table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let allRows = [];

async function loadRegistrations() {
  const type   = document.getElementById('filter-type').value;
  const status = document.getElementById('filter-status').value;
  const params = new URLSearchParams({ type, status });

  document.getElementById('reg-tbody').innerHTML =
    '<tr><td colspan="8" style="text-align:center;padding:24px;color:var(--text-muted)">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>';

  const res = await fetch('/api/admin/registrations?' + params).catch(() => null);
  if (!res || !res.ok) {
    document.getElementById('reg-tbody').innerHTML =
      '<tr><td colspan="8" style="text-align:center;padding:24px;color:var(--danger)">ë¡œë“œ ì‹¤íŒ¨</td></tr>';
    return;
  }
  const { registrations } = await res.json();
  allRows = registrations || [];
  renderTable(allRows);
}

function filterTable() {
  const q = document.getElementById('reg-search').value.toLowerCase();
  const filtered = allRows.filter(r =>
    (r.name  || '').toLowerCase().includes(q) ||
    (r.email || '').toLowerCase().includes(q)
  );
  renderTable(filtered);
}

const typeLabel  = { study: 'ìŠ¤í„°ë””', symposium: 'ì‹¬í¬ì§€ì—„', workshop: 'ì›Œí¬ìƒµ' };
const statusBadge = {
  pending:  '<span class="badge badge-warning">ê²€í†  ì¤‘</span>',
  approved: '<span class="badge badge-success">ìŠ¹ì¸ë¨</span>',
  rejected: '<span class="badge badge-danger">ê±°ì ˆë¨</span>'
};

function renderTable(rows) {
  const tbody = document.getElementById('reg-tbody');
  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:24px;color:var(--text-muted)">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    return;
  }
  tbody.innerHTML = rows.map((r, i) => `
    <tr>
      <td>${i + 1}</td>
      <td><span class="badge badge-info">${typeLabel[r.type] || r.type}</span></td>
      <td>${esc(r.name)}</td>
      <td style="font-size:.82rem">${esc(r.email)}</td>
      <td style="font-size:.82rem">${esc(r.affiliation)}</td>
      <td style="font-size:.82rem">${(r.created_at || '').slice(0,10)}</td>
      <td>${statusBadge[r.status] || r.status}</td>
      <td>
        <div class="table-actions">
          <button onclick="setStatus(${r.id},'approved')" title="ìŠ¹ì¸">âœ…</button>
          <button onclick="setStatus(${r.id},'rejected')" title="ê±°ì ˆ">âŒ</button>
          <button onclick="setStatus(${r.id},'pending')"  title="ê²€í† ì¤‘">â³</button>
          <button onclick="delReg(${r.id})" title="ì‚­ì œ" style="color:var(--danger)">ğŸ—‘</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function esc(str) {
  return (str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function setStatus(id, status) {
  const res = await fetch('/api/admin/registrations', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id, status })
  });
  if (res.ok) { toast('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.'); loadRegistrations(); loadKPI(); }
  else toast('ë³€ê²½ ì‹¤íŒ¨', 'error');
}

async function delReg(id) {
  if (!confirm('ì´ ì‹ ì²­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const res = await fetch('/api/admin/registrations?id=' + id, { method: 'DELETE' });
  if (res.ok) { toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); loadRegistrations(); loadKPI(); }
  else toast('ì‚­ì œ ì‹¤íŒ¨', 'error');
}

/* â”€â”€ CSV Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function exportCSV() {
  if (!allRows.length) { toast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
  const header = ['ID', 'ìœ í˜•', 'ì´ë¦„', 'ì´ë©”ì¼', 'ì†Œì†', 'ë‚ ì§œ', 'ìƒíƒœ'];
  const rows = allRows.map(r => [
    r.id, typeLabel[r.type] || r.type,
    r.name, r.email, r.affiliation,
    (r.created_at || '').slice(0,10), r.status
  ].map(v => `"${String(v || '').replace(/"/g, '""')}"`).join(','));
  const csv = [header.join(','), ...rows].join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,\uFEFF' + encodeURIComponent(csv);
  a.download = `registrations_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

/* â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadSettings() {
  const res = await fetch('/api/admin/settings').catch(() => null);
  if (!res || !res.ok) return;
  const { settings } = await res.json();
  const map = {};
  (settings || []).forEach(s => map[s.key] = s.value);

  // Registration toggle
  const isOpen = map.reg_open === 'true';
  const toggle = document.getElementById('reg-open-toggle');
  toggle.checked = isOpen;
  updateToggleLabel(isOpen);

  // Other fields
  ['site_name', 'contact_email', 'max_capacity'].forEach(k => {
    const el = document.getElementById('s-' + k);
    if (el) el.value = map[k] || '';
  });
}

function updateToggleLabel(isOpen) {
  const lbl  = document.getElementById('reg-status-label');
  const wrap = document.getElementById('reg-toggle-wrap');
  lbl.textContent = isOpen ? 'âœ… ì‹ ì²­ í™œì„±í™” (ëª¨ì§‘ ì¤‘)' : 'ğŸ”’ ì‹ ì²­ ë¹„í™œì„±í™” (ëª¨ì§‘ ì¢…ë£Œ)';
  wrap.className  = 'reg-status-toggle ' + (isOpen ? 'reg-open' : 'reg-close');
}

document.getElementById('reg-open-toggle').addEventListener('change', async function() {
  const open = this.checked;
  updateToggleLabel(open);
  const res = await fetch('/api/admin/settings', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reg_open: open ? 'true' : 'false' })
  });
  if (res.ok) toast(open ? 'ì‹ ì²­ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹ ì²­ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
  else { toast('ì €ì¥ ì‹¤íŒ¨', 'error'); this.checked = !open; updateToggleLabel(!open); }
});

async function saveSettings() {
  const body = {};
  ['site_name', 'contact_email', 'max_capacity'].forEach(k => {
    const el = document.getElementById('s-' + k);
    if (el) body[k] = el.value;
  });
  const res = await fetch('/api/admin/settings', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (res.ok) toast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  else toast('ì €ì¥ ì‹¤íŒ¨', 'error');
}

/* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(async () => {
  await authCheck();
  loadKPI();
  loadRegistrations();
})();
</script>
</body>
</html>
